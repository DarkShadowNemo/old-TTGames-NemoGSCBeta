from struct import pack, unpack
import bpy
import struct


    
def NUWrite(filepath):
    with open(filepath, "wb") as f:
        f.write(b"NU20")
        f.write(pack("<i", -abs(16+15+1*len(bpy.data.materials)*464+16+1+14+1*len(bpy.data.objects)*448+2+16+1*len(bpy.data.objects)*80+16+16)))
        f.write(pack("<I", 6))
        f.write(pack("<I", 0))
        f.write(b"NTBL")
        f.write(pack("<I", 16))
        f.write(pack("<I", 0))
        f.write(pack("<I", 0))
        ##########################
        f.write(b"MS00")
        f.write(pack("<I", len(bpy.data.materials)*464+16))
        f.write(pack("<I", len(bpy.data.materials)))
        f.write(pack("<I", 0))
        MaterialID=1
        MaterialNameID = 0
        BSDF = "Principled BSDF"
        for i, mat in enumerate(bpy.data.materials):
            f.write(pack("B", 13))
            f.write(pack("B", 0))
            f.write(pack("B", 1))
            f.write(pack("B", 96))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))

            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 16))
            f.write(pack("B", 8))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 80))
            f.write(pack("B", 7))
            f.write(pack("B", 128))
            f.write(pack("B", 0))
            f.write(pack("B", 0))

            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 16))
            f.write(pack("B", 14))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))

            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 8))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 27))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 68))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 68))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 140))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 1))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 78))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 224))
            f.write(pack("B", 37))
            f.write(pack("B", 5))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 71))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 127))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 127))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 127))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 1))
            f.write(pack("B", 1))
            f.write(pack("B", 0))
            f.write(pack("B", 1))
            f.write(pack("B", 19))
            f.write(pack("B", 0))
            f.write(pack("B", 3))
            f.write(pack("B", 108))
            f.write(pack("<f", 1))
            f.write(pack("<f", 1))
            f.write(pack("<f", 1))
            f.write(pack("<f", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 48))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))

            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("B", 0))
            f.write(pack("<I", 25))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0))
            f.write(pack("<I", 16384))
            f.write(pack("<I", 10758192))
            f.write(pack("<I", 4795408))
            f.write(pack("<I", 0))
            f.write(pack("B", 255))
            f.write(pack("B", 255))
            f.write(pack("B", 255))
            f.write(pack("B", 255))
            f.write(pack("B", 255))
            f.write(pack("B", 255))
            f.write(pack("B", 255))
            f.write(pack("B", 255))
            f.write(pack("B", 255))
            f.write(pack("B", 255))
            f.write(pack("B", 255))
            f.write(pack("B", 255))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0x3D))
            f.write(pack("<I", 0))
            f.write(pack("<I", 10758360))#
            f.write(pack("<I", 8904624))#
            f.write(pack("<I", 10010848))#
            f.write(pack("<I", 0))#
            f.write(pack("<f", mat.specular_intensity))
            f.write(pack("<I", 19))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0))
            f.write(pack("<f", mat.node_tree.nodes[BSDF].inputs[0].default_value[0]))
            f.write(pack("<f", mat.node_tree.nodes[BSDF].inputs[0].default_value[1]))
            f.write(pack("<f", mat.node_tree.nodes[BSDF].inputs[0].default_value[2]))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0))
            f.write(pack("<f", mat.roughness))
            f.write(pack("<I", 0))
            f.write(pack("<I", MaterialID))
            f.write(pack("<I", 65446))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0))
            f.write(pack("<I", 0xFF000000))
            f.write(pack("<I", 0))
            MaterialID+=1
            MaterialNameID+=1
        f.write(b"OBJ0")
        f.write(pack("<I", 448*len(bpy.data.objects)+16))
        f.write(pack("<I", len(bpy.data.objects)))
        f.write(pack("<I", 0))
        VertexDataCount = 4
        obd = bpy.context.object.data
        if VertexDataCount == len(obd.vertices):
            
            for i, obdata in enumerate(bpy.data.meshes):
                f.write(pack("<I", 4))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 1))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 123))
                f.write(pack("<I", 456))
                f.write(pack("<I", 789))
                f.write(pack("<I", 0))
                f.write(pack("<I", 96))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                            
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                            
                f.write(pack("<I", 256))

                f.write(pack("<H", 12))
                f.write(pack("<H", 24581))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<H", 86))
                f.write(pack("<H", 27649))
                f.write(pack("<I", 32768))
                f.write(pack("B", 0))
                f.write(pack("<H", 704))
                f.write(pack("B", 30))
                f.write(pack("B", 18))
                f.write(pack("B", 5))
                f.write(pack("B", 0))
                f.write(pack("B", 0))
                f.write(pack("<I", 0))
                f.write(pack("B", 0xD2))
                f.write(pack("B", 128))
                f.write(pack("B", 1))
                f.write(pack("B", 108))
                f.write(pack("B", 4))
                f.write(pack("<I", 128))
                f.write(pack("B", 64))
                f.write(pack("B", 2))
                f.write(pack("B", 48))
                f.write(pack("<I", 1298))
                f.write(pack("<I", 0))
                f.write(pack("B", 2))
                f.write(pack("B", 128))
                f.write(pack("B", 1))
                f.write(pack("B", 109))
                f.write(pack("<I", 4*3))
                f.write(pack("<I", 0))
                f.write(pack("B", 3))
                f.write(pack("B", 1))
                f.write(pack("B", 0))
                f.write(pack("B", 1))
                f.write(pack("B", 3))
                f.write(pack("B", 128))
                f.write(pack("B", 4))
                f.write(pack("B", 108))
                color_layer = obdata.vertex_colors.active.data
                for v in obdata.vertices:
                    f.write(pack("<f", v.co.x))
                    f.write(pack("<f", v.co.y))
                    f.write(pack("<f", v.co.z))
                    f.write(pack("<f", 1))
                f.write(pack("B", 1))
                f.write(pack("B", 0))
                f.write(pack("B", 0))
                f.write(pack("B", 5))
                f.write(pack("B", 4))
                f.write(pack("B", 128))
                f.write(pack("B", 4))
                f.write(pack("B", 101))
                uv_layer = obdata.uv_layers.active.data
                for v in obdata.vertices:
                    f.write(pack("<H", int(10000*uv_layer[v.index].uv[0])))
                    f.write(pack("<H", int(10000*uv_layer[v.index].uv[1])))
                f.write(pack("B", 0))
                f.write(pack("B", 0))
                f.write(pack("B", 0))
                f.write(pack("B", 5))
                f.write(pack("B", 5))
                f.write(pack("B", 192))
                f.write(pack("B", 4))
                f.write(pack("B", 110))
                for v in obdata.vertices:
                    f.write(pack("B", int(127*color_layer[v.index].color[0])))
                    f.write(pack("B", int(127*color_layer[v.index].color[1])))
                    f.write(pack("B", int(127*color_layer[v.index].color[2])))
                    f.write(pack("B", int(127*color_layer[v.index].color[3])))
                f.write(pack("B", 1))
                f.write(pack("B", 1))
                f.write(pack("B", 0))
                f.write(pack("B", 1))
                f.write(pack("B", 0))
                f.write(pack("B", 3))
                f.write(pack("B", 0))
                f.write(pack("B", 20))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))

                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<I", 0))
                f.write(pack("<f", 1))
                f.write(pack("<f", 1))
                f.write(pack("<f", 1))
                f.write(pack("<f", 1))
                f.write(pack("<f", 1))
                f.write(pack("<f", 1))
                f.write(pack("<f", 1))
                f.write(pack("<f", 1))
        else:
            raise Exception("ERROR Must be 4 vertices only, 4 uv verts and 4 rgba verts")
        f.write(b"INST")
        f.write(pack("<I", len(bpy.data.objects)*80+16))
        f.write(pack("<I", len(bpy.data.objects)))
        f.write(pack("<I", 0))
        objIndex=0
        for i, obj in enumerate(bpy.data.objects):
            f.write(pack("<f", 1))
            f.write(pack("<f", 0))
            f.write(pack("<f", 0))
            f.write(pack("<f", 0))
            f.write(pack("<f", 0))
            f.write(pack("<f", 1))
            f.write(pack("<f", 0))
            f.write(pack("<f", 0))
            f.write(pack("<f", 0))
            f.write(pack("<f", 0))
            f.write(pack("<f", 1))
            f.write(pack("<f", 0))
            f.write(pack("<f", obj.location[0]))
            f.write(pack("<f", obj.location[1]))
            f.write(pack("<f", obj.location[2]))
            f.write(pack("<f", 1))
            f.write(pack("<I", objIndex))
            f.write(pack("<I", 37))
            f.write(pack("<f", 0))
            f.write(pack("<f", 0))
            objIndex+=1
        f.write(b"SST0")
        f.write(pack("<I", 16))
        f.write(pack("<I", 0))
        f.write(pack("<I", 0))
        f.write(b"BNDS")
        f.write(pack("<I", 16))
        f.write(pack("<I", 0))
        f.write(pack("<I", 0))
        
            
